---
name: using-git-worktrees
description: 当需要在不干扰当前工作区的情况下处理并行任务、修复紧急 Bug 或进行多版本对比测试时使用。
---

# 使用 Git Worktrees (Using Git Worktrees)

## 概述

Git Worktree 允许在同一仓库中同时检出多个分支到不同的物理目录，实现开发任务的物理级隔离，避免分支切换导致的构建缓存失效。

**核心原则：**
1.  **物理隔离**：每个分支拥有独立的工作目录和依赖环境。
2.  **规范路径**：必须遵循统一的目录层级与命名规范。
3.  **安全准入**：严禁将 Worktree 目录泄露到主仓库的 Git 追踪范围内。
4.  **状态验证**：所有 Worktree 必须在通过基线测试后方可投入使用。

## 何时使用

- **并行任务**：正在处理 Feature A 时，需要立即切换到分支 B 修复 Bug 或进行 PR 评审。
- **环境对比**：需要同时运行两个不同版本的项目以对比行为差异。
- **长时阻塞**：当前分支正在进行耗时编译或大型测试，需在另一分支继续编码。
- **环境纯净度要求**：需要一套完全干净的依赖环境来复现特定 Bug。

**何时不使用：**
- 极小规模的代码调整（如仅修改一个常量）。
- 宿主机磁盘空间极度匮乏。

## 核心法则

### 1. 目录管理 (Directory Management)

**必须**按以下优先级确定 Worktree 的根路径，严禁随意散落在项目根目录：
1.  **现有目录优先**：检测项目根目录下是否存在 `.worktrees` 或 `worktrees` 目录。若同时存在，**必须**使用 `.worktrees`。
2.  **遵循项目约定**：检查 `GEMINI.md` 或 `CLAUDE.md` 中定义的 `worktree directory` 偏好（使用 `grep -i "worktree.*director" GEMINI.md`）。
3.  **最终确认**：若无预设，**必须**询问用户选择 `.worktrees/` (项目本地) 或 `~/.config/gemini/worktrees/<项目名>/` (全局路径)。

### 2. 隔离性与安全验证

**必须**验证目录隔离的安全性：
- **忽略状态校验**：在项目子目录下创建 Worktree 前，**必须**执行 `git check-ignore -q <路径>`。若未被忽略，**必须**先将路径写入 `.gitignore` 并提交。
- **命名一致性**：Worktree 的文件夹名称**必须**与分支名保持完全一致。

### 3. 环境与基线自动化

创建 Worktree (`git worktree add <路径> -b <分支>`) 后，**必须**执行初始化：
- **依赖安装**：根据项目类型自动执行 `npm install`、`cargo build`、`go mod download` 或 `poetry install`。
- **基线验证**：**必须**运行项目主干测试（如 `npm test`）。若初始测试未通过，**必须**停止操作并报告，严禁在故障基线上进行任何开发。

## 借口粉碎机 (Excuse Smasher)

| 借口 | 事实反击 |
|------|----------|
| “用 `git stash` 切换分支更简单” | Stash 无法保留 `node_modules` 或构建产物。Worktree 切换是瞬时的，且互不干扰。 |
| “我手动创建文件夹就行，不用这个流程” | 手动管理会导致路径混乱和忽略规则失效。规范化的目录管理是防止系统垃圾堆积的唯一手段。 |
| “忽略验证太麻烦了，我保证不提交” | 只要目录未被忽略，`git status` 就会被污染，误提交只是时间问题。 |
| “环境初始化太慢，我等下再弄” | 缺少依赖的环境会产生大量的伪报错，反而极大降低开发效率。 |

## 危险信号 (Red Flags)

- **目录污染**：在项目目录下创建了未被 `.gitignore` 覆盖的 Worktree -> **立即停止并修正忽略规则**。
- **基线故障**：在基线测试失败的情况下直接开始新功能开发 -> **立即停止并报告故障**。
- **命名冲突**：Worktree 目录名与分支名不一致 -> **立即删除并重新按规范创建**。
- **盲目操作**：未确认目录位置优先级便随意创建文件夹 -> **立即撤销并遵循优先级流程**。

## 常用操作参考

```bash
# 1. 检查忽略状态
git check-ignore -v .worktrees/

# 2. 安全创建并切换
git worktree add .worktrees/feat-api -b feat-api
cd .worktrees/feat-api

# 3. 环境初始化示例 (Node)
npm install && npm test

# 4. 彻底清理
git worktree remove <路径>
```