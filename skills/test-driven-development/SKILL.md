---
name: test-driven-development
description: 在实施任何逻辑变更或修复 Bug 之前使用，强制执行先写测试、后写实现的研发模式。
---

# 测试驱动开发 (TDD)

## 概述

本技能通过红-绿-重构闭环与测试质量门禁，确保每一行实现都有明确行为约束，防止“补测”与“假绿”。

**核心原则**
1. **测试先行**：没有失败测试，不允许写实现。
2. **最小实现**：只写刚好通过测试的代码。
3. **禁止补测**：实现后补测试视为违规。
4. **质量门禁**：测试必须通过异味检查。

## 何时使用

- 新功能或新接口。
- 修复已知 Bug（先写复现测试）。
- 重构前保障回归。

## 强制流程 (Workflow)

### 1. Red
- 写一个失败测试，说明预期行为。
- 运行测试并确认失败原因符合预期。

### 2. Green
- 写最少实现使测试通过。
- 禁止同时引入新功能。

### 3. Refactor
- 清理重复、优化命名、提升结构。
- 重构后必须全量回归测试通过。

### 4. 质量门禁 (Quality Gate)
测试必须通过以下检查：
- **无假绿**：禁止 `assert true` 或无效断言。
- **无过度耦合**：测试不依赖执行顺序。
- **无神奇常量**：测试中的常量必须可解释。
- **可读性**：测试名称清晰表达行为。

## 测试异味 (Test Smells)
出现即视为违规：
- **Eager Test**：一个测试验证多个不相关行为。
- **Mystery Guest**：测试依赖隐藏外部状态。
- **Test Interdependence**：测试之间相互影响。
- **Assertion Roulette**：多断言但无清晰失败定位。

## 禁令
- 禁止“先写实现后补测试”。
- 禁止跳过 Red 阶段。
- 禁止为通过测试而硬编码业务逻辑。

## 借口粉碎机 (Excuse Smasher)

| 借口 | 事实反击 |
|------|----------|
| “功能很小，不写测试” | 小功能是回归风险的主要来源。 |
| “先写实现更快” | 后补测试会漏掉边界与失败模式。 |
| “测试写不出来” | 说明设计未解耦，应先调整接口边界。 |

## 危险信号 (Red Flags)

- 测试一直绿而无法解释失败条件。
- 重构阶段引入新逻辑。
- 出现测试异味但未整改。
- 发现生产代码没有测试覆盖。
